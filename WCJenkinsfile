#!groovy

def baseVersion = "3.4.0.*"
def buildRoot = JOB_BASE_NAME.replaceAll(/-.*/, "") // Keep everything up to the first dash

stage('checkout') {
    node {
        git url: "https://github.com/sklintyg/intygstjanst.git", branch: GIT_BRANCH
        util.run { checkout scm }
    }
}

stage('deploy test-IT') {
    node {
        util.run {
            def itVersion = util.latestVersion("se/inera/intyg/intygstjanst/intygstjanst-web", baseVersion)

            ansiblePlaybook(extraVars: [version: "${itVersion}", ansible_ssh_port: "22", deploy_from_repo: "true", config_version: "IT-3.4"],
                            installation: 'ansible-yum', inventory: 'ansible/inventory/intygstjanst/test-wc', playbook: 'ansible/deploy.yml')

            util.waitForServer('https://webcert.inera.nordicmedtest.se/inera-certificate/version.jsp')
        }
    }
}

stage('propagate') {
    build job: "${buildRoot}-webcert", wait: false, parameters: [[$class: 'StringParameterValue', name: 'GIT_BRANCH', value: GIT_BRANCH]]
}
